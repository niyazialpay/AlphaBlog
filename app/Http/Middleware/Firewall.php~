<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Contracts\Routing\ResponseFactory;
use Illuminate\Foundation\Application;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Log;

/**
 * Eski 'PHP Firewall' scriptindeki mantıkları
 * Laravel middleware yapısına uyarlayan örnek sınıf
 */
class Firewall
{
    /**
     * Handle an incoming request.
     *
     * @param Request $request
     * @param Closure(Request): Response $next
     * @return Application|Response|ResponseFactory
     */
    public function handle(Request $request, Closure $next): Application|Response|ResponseFactory
    {
        $firewall = Firewall::first();
        // Firewall aktif mi?
        if (! $firewall || ! $firewall->is_active) {
            return $next($request);
        }


        // 2) Koruma türlerini kontrol et
        $protections = [
            'check_referer'          => $firewall->check_referer,
            'check_bots'             => $firewall->check_bots,
            'check_request_method'    => true,
            'check_dos'              => true,
            'check_union_sql'         => true,
            'check_click_attack'      => true,
            'check_xss'              => true,
            'check_cookie_injection'  => true,
        ];

        if ($firewall?->check_referer) {
            if (! $this->checkReferer($request)) {
                return $this->blockRequest('Referer engellendi', $request);
            }
        }

        if (! empty($protections['check_bots'])) {
            if ($this->isBadBot($request->userAgent())) {
                return $this->blockRequest('Bot engellendi', $request);
            }
        }

        if (! empty($protections['check_request_method'])) {
            if (! $this->checkRequestMethod($request)) {
                return $this->blockRequest('Geçersiz Request Method', $request);
            }
        }

        if (! empty($protections['check_dos'])) {
            if ($this->checkDosAttack($request)) {
                return $this->blockRequest('DOS saldırısı', $request);
            }
        }

        if (! empty($protections['check_union_sql'])) {
            if ($this->checkUnionSql($request)) {
                return $this->blockRequest('Union SQL saldırısı', $request);
            }
        }

        if (! empty($protections['check_click_attack'])) {
            if ($this->checkClickAttack($request)) {
                return $this->blockRequest('Click Attack', $request);
            }
        }

        if (! empty($protections['check_xss'])) {
            if ($this->checkXss($request)) {
                return $this->blockRequest('XSS saldırısı', $request);
            }
        }

        if (! empty($protections['check_cookie_injection'])) {
            if ($this->checkCookieInjection($request)) {
                return $this->blockRequest('Cookie Injection', $request);
            }
        }

        // Tüm kontrolleri geçiyorsa request'i devam ettir
        return $next($request);
    }

    /**
     * IP eşleşmesi (wildcard: 192.168.* gibi)
     */
    protected function ipMatch($ip, $pattern): bool
    {
        // Basit wildcard desteği
        if (str_contains($pattern, '*')) {
            $pattern = str_replace('*', '.*', preg_quote($pattern, '/'));
            return (bool) preg_match('/^'.$pattern.'$/', $ip);
        }

        // Direkt eşitlik kontrolü
        return $ip === $pattern;
    }

    /**
     * Referer kontrolü: Başka domainlerden gelen POST isteklerini engellemek vs.
     */
    protected function checkReferer(Request $request): bool
    {
        // Örnek: POST isteği ise, referer kendi domainimiz mi?
        if ($request->isMethod('post')) {
            $referer = $request->headers->get('referer');
            if ($referer && ! str_contains($referer, $request->getHost())) {
                return false;
            }
        }

        return true;
    }

    /**
     * Kötü niyetli bot tespiti (User-Agent üzerinden basit bir kontrol).
     */
    protected function isBadBot($userAgent)
    {
        if (! $userAgent) {
            return true; // UserAgent yoksa potansiyel zararlı kabul edelim
        }

        // Burada eski scriptten alınan bot isimleri/anahtar kelimeler vs.
        $badBots = [
            'apache', 'bandit', 'blackwidow', 'bot', 'crawler', 'disco', 'dragonfly', 'grabber',
            'harvest', 'httpconnect', 'httrack', 'larbin', 'nikto', 'wget', 'libwww', 'offline',
            'searchspider', 'sucker', 'turnitinbot', 'zeus',
            // vb. liste uzatılabilir
        ];

        $agent = strtolower($userAgent);
        foreach ($badBots as $badBot) {
            if (str_contains($agent, $badBot)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Sadece GET, HEAD, POST, PUT gibi methodlara izin verme.
     */
    protected function checkRequestMethod(Request $request): bool
    {
        $validMethods = ['get','head','post','put'];
        return in_array(strtolower($request->method()), $validMethods);
    }

    /**
     * Basit DoS saldırısı kontrolü:
     * Örneğin User-Agent boş, istek sayısı çok fazla vs. (Sadece örnek)
     */
    protected function checkDosAttack(Request $request)
    {
        // Burada sadece userAgent’in boş olmasını kontrol ediyoruz.
        // Gerçek bir DoS koruması için IP bazlı rate-limiting gibi önlemler gereklidir.
        $agent = $request->userAgent();
        if (! $agent || $agent === '-') {
            return true;
        }
        return false;
    }

    /**
     * UNION SQL saldırısı mı?
     * Sorgu parametrelerinde "union select" vb. var mı diye bakabiliriz.
     */
    protected function checkUnionSql(Request $request): bool
    {
        $queryString = strtolower($request->getQueryString() ?? '');
        if (empty($queryString)) {
            return false;
        }

        // Bazı kritik kelimeler
        $patterns = [
            '/\bunion\b.*\bselect\b/', // union select
            '/(\bor\b|\band\b)\s+\d=\d/', // or 1=1, vb.
        ];

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $queryString)) {
                return true;
            }
        }

        return false;
    }

    /**
     * "Click Attack" (Genelde zararlı JS kod parçacıkları) basit örnek.
     */
    protected function checkClickAttack(Request $request): bool
    {
        $queryString = strtolower($request->getQueryString() ?? '');
        if (str_contains($queryString, 'c2nyaxb0')) {
            // Örnek: eskiden 'c2nyaxb0' (script base64) aratılıyordu
            return true;
        }
        return false;
    }

    /**
     * XSS saldırısı tespiti: Parametrelerde <script> vb. arama.
     */
    protected function checkXss(Request $request): bool
    {
        $queryString = strtolower($request->getQueryString() ?? '');
        // Bazı riskli kelimeler
        $badStrings = [
            '<script', 'javascript:', 'vbscript:', 'onload=', 'onclick=',
            'alert(', 'document.cookie', 'expression(',
        ];

        foreach ($badStrings as $bad) {
            if (str_contains($queryString, $bad)) {
                return true;
            }
        }

        return false;
    }

    /**
     * Cookie / POST / GET enjeksiyonu kontrolü.
     * Eski scriptte tüm POST, GET, COOKIE değerleri zararlı etiketlere karşı taranıyordu.
     * Burada sadece basit bir örnek gösterelim.
     */
    protected function checkCookieInjection(Request $request): bool
    {
        $dangerousTags = [
            'applet','base','bgsound','blink','embed','expression','frame',
            'javascript','layer','link','meta','object','script','style',
            'title','vbscript','xml','onabort','onerror','onload','onclick',
            // vb. listeyi uzatabilirsiniz
        ];

        // Tüm Cookie değerlerinde arama
        foreach ($request->cookies as $value) {
            if ($this->containsDangerous($value, $dangerousTags)) {
                return true;
            }
        }
        // Tüm POST değerlerinde arama
        foreach ($request->post() as $value) {
            if ($this->containsDangerous($value, $dangerousTags)) {
                return true;
            }
        }
        // Tüm GET değerlerinde arama
        foreach ($request->query() as $value) {
            if ($this->containsDangerous($value, $dangerousTags)) {
                return true;
            }
        }

        return false;
    }

    protected function containsDangerous($haystack, array $badWords): bool
    {
        $haystack = strtolower($haystack);
        foreach ($badWords as $word) {
            if (str_contains($haystack, $word)) {
                return true;
            }
        }
        return false;
    }

    /**
     * İstek engellendiğinde ne yapılacağı:
     * - Log kaydı
     * - 403 döndürme
     */
    protected function blockRequest($reason, Request $request): Application|Response|ResponseFactory
    {
        if (config('firewall.logging.enabled')) {
            Log::{config('firewall.logging.level', 'warning')}(
                "[FIREWALL BLOK] Sebep: {$reason} | IP: {$request->ip()} | Agent: {$request->userAgent()} | URL: {$request->fullUrl()}"
            );
        }

        $blockMessage = config('firewall.block_message', 'Erişiminiz engellendi.');
        return response($blockMessage, 403);
    }
}

