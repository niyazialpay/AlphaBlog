<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Firewall\FirewallLogs;
use App\Models\IPFilter\IPList;
use Illuminate\Http\Request;
use Yajra\DataTables\Facades\DataTables;
use Yajra\DataTables\Exceptions\Exception;

class FirewallController extends Controller
{
    public function index()
    {
        return view('admin.firewall.index', [
            'ipFilters' => \App\Models\IPFilter\IPFilter::all(),
            'firewall' => \App\Models\Firewall\Firewall::first(),
        ]);
    }

    public function save(Request $request)
    {
        $firewall = \App\Models\Firewall\Firewall::first();
        $firewall->update($request->except('_token'));

        return redirect()->route('admin.firewall')->with('success', __('firewall.saved_success'));
    }

    public function logs()
    {
        return view('admin.firewall.logs');
    }

    /**
     * @throws \Exception
     */
    public function logsData(Request $request) {
        return DataTables::eloquent(FirewallLogs::with('ipFilter', 'ipList', 'ipList.filter'))
            ->addColumn('details', function () {
                return __('media.show');
            })
            ->addColumn('ip', function ($log) {
                return $log->ip;
            })
            ->addColumn('url', function ($log) {
                return $log->url;
            })
            ->addColumn('user_agent', function ($log) {
                return $log->user_agent;
            })
            ->addColumn('reason', function ($log) {
                return $log->reason;
            })
            ->addColumn('request_data', function ($log) {
                return '<pre>' . htmlspecialchars(json_encode(json_decode($log->request_data), JSON_PRETTY_PRINT)) . '</pre>';
            })
            ->addColumn('ip_filter', function ($log) {
                return $log->ipFilter->name;
            })
            ->addColumn('created_at', function ($log) {
                return $log->created_at->format('Y-m-d H:i:s');
            })
            ->addColumn('actions', function ($log) {
                return view('admin.firewall.logs.actions', ['log' => $log]);
            })
            ->rawColumns(['request_data', 'actions'])
            ->make(true);
    }

    public function whitelist(Request $request)
    {
        $firewall = \App\Models\Firewall\Firewall::first();
        IpList::updateOrCreate(
            [
                'ip'         => $request->ip,
            ],
            [
                'ip'         => $request->ip,
                'filter_id' => $firewall->whitelist_rule_id,
            ]
        );

        return response()->json(['success' => true]);
    }
}
